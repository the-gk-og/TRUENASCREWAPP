{% extends "base.html" %}

{% block title %}Admin Panel - ShowWise{% endblock %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-cog"></i> Admin Panel</h2>
    <p style="color: #666; margin-top: 0.5rem;">Manage users, database backups, and system settings.</p>
</div>

<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: 2rem;">
    <div class="card" style="text-align: center;">
        <h3 style="color: var(--primary);">👥</h3>
        <p id="crewCount" style="font-size: 2rem; font-weight: bold;">0</p>
        <p>Crew Members</p>
    </div>
    <div class="card" style="text-align: center;">
        <h3 style="color: var(--secondary);">🎭</h3>
        <p id="castCount" style="font-size: 2rem; font-weight: bold;">0</p>
        <p>Cast Members</p>
    </div>
    <div class="card" style="text-align: center;">
        <h3 style="color: var(--success);">📦</h3>
        <p id="equipCount" style="font-size: 2rem; font-weight: bold;">0</p>
        <p>Equipment Items</p>
    </div>
    <div class="card" style="text-align: center;">
        <h3 style="color: var(--warning);">📅</h3>
        <p id="eventCount" style="font-size: 2rem; font-weight: bold;">0</p>
        <p>Events</p>
    </div>
</div>

<!-- CREW MEMBERS MANAGEMENT -->

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3><i class="fas fa-users"></i> User Management</h3>
        <button onclick="showModal('addCrewModal')" class="btn btn-success"><i class="fas fa-plus"></i> Add User</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Discord</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            {% for user in users %}
            <tr>
                <td><strong>{{ user.username }}</strong></td>
                <td>{{ user.email or '-' }}</td>
                <td>
                    {% if user.is_admin and user.user_role == 'crew' %}
                    <span style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">Crew/Admin</span>
                    {% elif user.is_admin and user.user_role == 'staff' %}
                    <span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">Staff/Admin</span>
                    {% elif user.is_admin %}
                    <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">Admin</span>
                    {% elif user.user_role == 'cast' %}
                    <span style="background: #fce7f3; color: #9f1239; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">Cast</span>
                    {% elif user.user_role == "staff" %}
                    <span style="background: #fef3c7; color: #78350f; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">Staff</span>
                    {% else %}
                    <span style="background: #e5e7eb; color: var(--dark); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">crew</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.discord_username %}
                    <span style="background: #5865f2; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                        <i class="fab fa-discord"></i> {{ user.discord_username }}
                    </span>
                    {% else %}
                    <span style="color: #999;">Not linked</span>
                    {% endif %}
                </td>
                <td>{{ user.created_at }}</td>
                <td>
                    <button onclick="editUserModal({{ user.id }})" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"><i class="fas fa-edit"></i> Edit</button>
                    {% if user.id != current_user.id %}
                    <button onclick="deleteUser({{ user.id }})" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"><i class="fas fa-trash"></i> Delete</button>
                    {% else %}
                    <span style="color: #999; font-size: 0.85rem;">Current User</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Updated Add User Modal -->
<div id="addCrewModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('addCrewModal')">&times;</span>
        <h2 style="margin-bottom: 1.5rem;">Add User</h2>
        <form id="addCrewForm">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="crewUsername" required>
            </div>
            <div class="form-group">
                <label>Email (Optional - for notifications)</label>
                <input type="email" id="crewEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="crewPassword" required>
            </div>
            <div class="form-group">
                <label>User Role *</label>
                <select id="userRole" required>
                    <option value="crew">Crew</option>
                    <option value="staff">Staff</option>
                    <option value="cast">Cast</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" id="isAdmin" style="width: auto;">
                    <span>Grant Admin Privileges</span>
                </label>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;"><i class="fas fa-plus"></i> Create User</button>
        </form>
    </div>
</div>

<!-- Updated Edit User Modal -->
<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('editUserModal')">&times;</span>
        <h2 style="margin-bottom: 1.5rem;">Edit User</h2>
        <form id="editUserForm">
            <input type="hidden" id="editUserId">
            
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="editUsername" required>
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" placeholder="user@example.com">
            </div>
            
            <div class="form-group">
                <label>User Role *</label>
                <select id="editUserRole" required>
                    <option value="crew">Crew</option>
                    <option value="staff">Staff</option>
                    <option value="cast">Cast</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" id="editIsAdmin" style="width: auto;">
                    <span>Grant Admin Privileges</span>
                </label>
            </div>
            
            <div class="form-group">
                <label>Password (Leave blank to keep current password)</label>
                <input type="password" id="editPassword" placeholder="Enter new password (min 6 chars)">
            </div>
            
            <div style="background: #f0f4ff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">Discord Integration</h4>
                
                <div class="form-group">
                    <label>Discord ID</label>
                    <input type="text" id="editDiscordId" placeholder="Leave blank to unlink">
                </div>
                
                <div class="form-group">
                    <label>Discord Username</label>
                    <input type="text" id="editDiscordUsername" placeholder="e.g., username#1234">
                </div>
                
                <p style="font-size: 0.85rem; color: #666; margin: 0;">
                    💡 <strong>Tip:</strong> Leave both Discord fields blank to unlink the account.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-success" style="flex: 1;"><i class="fas fa-save"></i> Save Changes</button>
                <button type="button" onclick="hideModal('editUserModal')" class="btn btn-primary" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- CAST MEMBERS MANAGEMENT -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3><i class="fas fa-theater-masks"></i> Cast Members Management</h3>
        <button onclick="showModal('addCastModal')" class="btn btn-success"><i class="fas fa-plus"></i> Add Cast Member</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Productions</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="castTableBody">
            {% for user in users %}
            {% if user.is_cast %}
            <tr>
                <td><strong>{{ user.username }}</strong></td>
                <td>{{ user.email or '-' }}</td>
                <td>
                    <span style="background: #fce7f3; color: #9f1239; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                        {{ user.cast_roles|length }} productions
                    </span>
                </td>
                <td>{{ user.created_at }}</td>
                <td>
                    <button onclick="editUserModal({{ user.id }})" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"><i class="fas fa-edit"></i> Edit</button>
                    {% if user.id != current_user.id %}
                    <button onclick="deleteUser({{ user.id }})" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"><i class="fas fa-trash"></i> Delete</button>
                    {% else %}
                    <span style="color: #999; font-size: 0.85rem;">Current User</span>
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Database Management -->
<div class="card">
    <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-database"></i> Database Management</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div>
            <h4 style="margin-bottom: 1rem; color: var(--primary);">Backup</h4>
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Create a backup of your database</p>
            <button onclick="createBackup()" class="btn btn-success" style="width: 100%;"><i class="fas fa-download"></i> Create Backup</button>
        </div>
        <div>
            <h4 style="margin-bottom: 1rem; color: var(--secondary);">Restore</h4>
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Restore from a backup file</p>
            <button onclick="showModal('restoreModal')" class="btn btn-primary" style="width: 100%;"><i class="fas fa-upload"></i> Restore Backup</button>
        </div>
    </div>
    
    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px;">
        <h4 style="margin-bottom: 1rem;"><i class="fas fa-history"></i> Recent Backups</h4>
        <div id="backupsList" style="max-height: 300px; overflow-y: auto;">
            <p style="color: #999; text-align: center;">Loading backups...</p>
        </div>
    </div>
</div>

<!-- Import Equipment -->
<div class="card">
    <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-file-import"></i> Import Equipment</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem;">
        <!-- CSV Import -->
        <div>
            <h4 style="margin-bottom: 1rem; color: var(--primary);">Import from CSV</h4>
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Upload a CSV file with columns: barcode, name, category, location, notes</p>
            <form id="csvForm" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="csvFile" accept=".csv" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;"><i class="fas fa-upload"></i> Import CSV</button>
            </form>
        </div>
        
        <!-- SheetDB Import -->
        <div>
            <h4 style="margin-bottom: 1rem; color: var(--secondary);">Import from SheetDB</h4>
            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Connect to your Google Sheet via SheetDB</p>
            <form id="sheetdbForm">
                <div class="form-group">
                    <label>SheetDB ID *</label>
                    <input type="text" id="sheetId" placeholder="e.g., abc123def456" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;"><i class="fas fa-database"></i> Import from Sheet</button>
            </form>
        </div>
    </div>
</div>



<!-- Add Cast Member Modal -->
<div id="addCastModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('addCastModal')">&times;</span>
        <h2 style="margin-bottom: 1.5rem;">Add Cast Member</h2>
        <form id="addCastForm">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="castUsername" required>
            </div>
            <div class="form-group">
                <label>Email (Optional)</label>
                <input type="email" id="castEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="castPassword" required>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;"><i class="fas fa-plus"></i> Create Cast Member</button>
        </form>
    </div>
</div>



<!-- Restore Modal -->
<div id="restoreModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('restoreModal')">&times;</span>
        <h2 style="margin-bottom: 1.5rem; color: var(--danger);">⚠️ Restore Database</h2>
        <p style="color: #666; margin-bottom: 1.5rem; background: #fef2f2; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--danger);">
            <strong>Warning:</strong> This will replace your current database with the backup. Current data will be lost!
        </p>
        <form id="restoreForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Select Backup File *</label>
                <input type="file" id="restoreFile" accept=".db" required>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" id="confirmRestore" required>
                    <span style="color: var(--danger); font-weight: 600;">I understand this will replace my current database</span>
                </label>
            </div>
            <button type="submit" class="btn btn-danger" style="width: 100%;"><i class="fas fa-exclamation-triangle"></i> Restore Database</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>


// Load stats
function loadStats() {
    const allUsers = {{ users|tojson }};
    const crewCount = allUsers.filter(u => !u.is_cast).length;
    const castCount = allUsers.filter(u => u.is_cast).length;
    
    document.getElementById('crewCount').textContent = crewCount;
    document.getElementById('castCount').textContent = castCount;
}

// Add User Form Handler
document.getElementById('addCrewForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        username: document.getElementById('crewUsername').value,
        email: document.getElementById('crewEmail').value || null,
        password: document.getElementById('crewPassword').value,
        is_admin: document.getElementById('isAdmin').checked,
        user_role: document.getElementById('userRole').value
    };
    
    console.log('Adding user with data:', data); // Debug log
    
    fetch('/admin/users/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('User created successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error, 'error');
        }
    })
    .catch(err => {
        console.error('Add user error:', err);
        showAlert('Error creating user: ' + err.message, 'error');
    });
});

// Add Cast Member Form Handler
document.getElementById('addCastForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const data = {
        username: document.getElementById('castUsername').value,
        email: document.getElementById('castEmail').value || null,
        password: document.getElementById('castPassword').value,
        user_role: 'cast',
        is_cast: true
    };
    
    console.log('Creating cast member with data:', data);
    
    fetch('/cast/create-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Cast member account created!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error, 'error');
        }
    })
    .catch(err => {
        console.error('Create cast error:', err);
        showAlert('Error: ' + err.message, 'error');
    });
});

// Load backups list
function loadBackups() {
    fetch('/admin/backups')
        .then(r => r.json())
        .then(backups => {
            let html = '';
            if (backups.length === 0) {
                html = '<p style="color: #999; text-align: center;">No backups yet</p>';
            } else {
                html = '<table style="font-size: 0.9rem;"><tbody>';
                backups.forEach(backup => {
                    const date = new Date(backup.date);
                    const size = (backup.size / 1024 / 1024).toFixed(2);
                    html += `
                        <tr>
                            <td>
                                <strong>${backup.name}</strong><br>
                                <small style="color: #999;">${size} MB • ${date.toLocaleString()}</small>
                            </td>
                            <td style="text-align: right; white-space: nowrap;">
                                <a href="/admin/download-backup/${backup.name}" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"><i class="fas fa-download"></i></a>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
            }
            document.getElementById('backupsList').innerHTML = html;
        })
        .catch(err => {
            console.error('Load backups error:', err);
            document.getElementById('backupsList').innerHTML = '<p style="color: #ef4444;">Error loading backups</p>';
        });
}

// Create backup
function createBackup() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    
    fetch('/admin/backup', {method: 'POST'})
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showAlert('Backup created successfully!', 'success');
                loadBackups();
            } else {
                showAlert('Error creating backup', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        })
        .catch(err => {
            console.error('Create backup error:', err);
            showAlert('Error: ' + err.message, 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}

// Edit user modal - Load user data
function editUserModal(userId) {
    console.log('=== LOADING USER FOR EDIT ===');
    console.log('User ID:', userId);
    
    fetch(`/admin/users/get/${userId}`)
        .then(r => r.json())
        .then(user => {
            console.log('Received user data from server:', user);
            
            // Set all form fields
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email || '';
            
            // Set user role dropdown
            const roleDropdown = document.getElementById('editUserRole');
            const roleToSet = user.user_role || 'crew';
            roleDropdown.value = roleToSet;
            console.log('Set role dropdown to:', roleToSet);
            console.log('Role dropdown current value:', roleDropdown.value);
            
            // Set admin checkbox
            document.getElementById('editIsAdmin').checked = user.is_admin || false;
            console.log('Set is_admin to:', user.is_admin || false);
            
            // Set Discord fields
            document.getElementById('editDiscordId').value = user.discord_id || '';
            document.getElementById('editDiscordUsername').value = user.discord_username || '';
            
            // Clear password field
            document.getElementById('editPassword').value = '';
            
            console.log('=== FINISHED LOADING USER ===');
            
            showModal('editUserModal');
        })
        .catch(err => {
            console.error('Error loading user:', err);
            showAlert('Failed to load user data: ' + err.message, 'error');
        });
}

// Edit user form submission
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('=== SUBMITTING USER EDIT ===');
    
    const userId = document.getElementById('editUserId').value;
    const roleDropdown = document.getElementById('editUserRole');
    const selectedRole = roleDropdown.value;
    
    console.log('User ID:', userId);
    console.log('Role dropdown element:', roleDropdown);
    console.log('Selected role:', selectedRole);
    console.log('All dropdown options:', Array.from(roleDropdown.options).map(o => ({value: o.value, text: o.text, selected: o.selected})));
    
    const data = {
        username: document.getElementById('editUsername').value,
        email: document.getElementById('editEmail').value || null,
        password: document.getElementById('editPassword').value || null,
        user_role: selectedRole,
        is_admin: document.getElementById('editIsAdmin').checked,
        discord_id: document.getElementById('editDiscordId').value || null,
        discord_username: document.getElementById('editDiscordUsername').value || null
    };
    
    console.log('Data being sent to server:', data);
    console.log('JSON payload:', JSON.stringify(data));
    
    fetch(`/admin/users/edit/${userId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => {
        console.log('Response status:', r.status);
        return r.json();
    })
    .then(result => {
        console.log('Server response:', result);
        console.log('=== END USER EDIT ===');
        
        if (result.success) {
            showAlert('User updated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error || 'Error updating user', 'error');
        }
    })
    .catch(err => {
        console.error('Update error:', err);
        console.log('=== END USER EDIT (ERROR) ===');
        showAlert('Error: ' + err.message, 'error');
    });
});

// CSV import
document.getElementById('csvForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('file', document.getElementById('csvFile').files[0]);
    
    fetch('/equipment/import-csv', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(`Imported ${result.imported} items from CSV!`, 'success');
            document.getElementById('csvFile').value = '';
        } else {
            showAlert(result.error, 'error');
        }
    })
    .catch(err => {
        console.error('CSV import error:', err);
        showAlert('Error: ' + err.message, 'error');
    });
});

// SheetDB import
document.getElementById('sheetdbForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const data = {
        sheet_id: document.getElementById('sheetId').value
    };
    
    fetch('/equipment/import-sheetdb', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(`Imported ${result.imported} items from SheetDB!`, 'success');
            document.getElementById('sheetId').value = '';
        } else {
            showAlert(result.error, 'error');
        }
    })
    .catch(err => {
        console.error('SheetDB import error:', err);
        showAlert('Error: ' + err.message, 'error');
    });
});

// Restore database
document.getElementById('restoreForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!confirm('⚠️ WARNING: This will replace your entire database!\n\nAre you absolutely sure?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file', document.getElementById('restoreFile').files[0]);
    
    fetch('/admin/restore', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error, 'error');
        }
    })
    .catch(err => {
        console.error('Restore error:', err);
        showAlert('Error: ' + err.message, 'error');
    });
});

// Delete user
function deleteUser(id) {
    if (!confirm('Delete this user? This action cannot be undone.')) return;
    
    fetch(`/admin/users/delete/${id}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showAlert('User deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(result.error, 'error');
            }
        })
        .catch(err => {
            console.error('Delete user error:', err);
            showAlert('Error: ' + err.message, 'error');
        });
}

// Initialize
loadStats();
loadBackups();
setInterval(loadBackups, 30000); // Refresh every 30 seconds
</script>

{% endblock %}
