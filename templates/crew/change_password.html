{% extends "base.html" %}

{% block title %}Change Password - ShowWise{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-key"></i> Change Password</h1>
    <p class="page-subtitle">Update your account password</p>
</div>

<div class="card" style="max-width: 600px; margin: 0 auto;">
    <div style="background: #f0f4ff; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 1.5rem;">
        <p style="margin: 0; color: #1e40af; font-size: 0.95rem;">
            <i class="fas fa-info-circle"></i> <strong>Password Requirements:</strong>
        </p>
        <ul style="margin: 0.5rem 0 0 1.5rem; color: #1e40af; font-size: 0.9rem; line-height: 1.6;">
            <li>Minimum 6 characters</li>
            <li>Must be different from current password</li>
            <li>Use a strong, unique password</li>
        </ul>
    </div>
    
    <form id="changePasswordForm">
        <div class="form-group">
            <label><i class="fas fa-lock"></i> Current Password *</label>
            <input type="password" id="currentPassword" required placeholder="Enter your current password" autocomplete="current-password">
        </div>
        
        <div class="form-group">
            <label><i class="fas fa-key"></i> New Password *</label>
            <input type="password" id="newPassword" required placeholder="Enter new password (min 6 characters)" autocomplete="new-password">
            <div style="margin-top: 0.5rem;">
                <div style="height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                    <div id="passwordStrength" style="height: 100%; width: 0%; transition: all 0.3s ease;"></div>
                </div>
                <small id="strengthText" style="color: #6b7280; display: block; margin-top: 0.25rem;"></small>
            </div>
        </div>
        
        <div class="form-group">
            <label><i class="fas fa-check-double"></i> Confirm New Password *</label>
            <input type="password" id="confirmPassword" required placeholder="Re-enter new password" autocomplete="new-password">
            <small id="matchText" style="display: block; margin-top: 0.25rem;"></small>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-success" style="flex: 1;" id="submitBtn">
                <i class="fas fa-check"></i> Change Password
            </button>
            <a href="{% if current_user.is_cast and not current_user.is_admin %}{{ url_for('cast_events') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="btn btn-primary" style="flex: 1; text-align: center;">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<!-- Success Message Card -->
<div id="successCard" class="card" style="max-width: 600px; margin: 2rem auto; display: none; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid var(--success);">
    <div style="text-align: center; padding: 1rem;">
        <p style="font-size: 3rem; margin-bottom: 0.5rem;">✅</p>
        <h3 style="color: var(--success); margin-bottom: 0.5rem;">Password Changed!</h3>
        <p style="color: #065f46; margin-bottom: 1rem;">Your password has been updated successfully.</p>
        <a href="{% if current_user.is_cast and not current_user.is_admin %}{{ url_for('cast_events') }}{% else %}{{ url_for('dashboard') }}{% endif %}" class="btn btn-success">
            <i class="fas fa-home"></i> Return to Dashboard
        </a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Password strength checker
document.getElementById('newPassword').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');
    
    let strength = 0;
    let color = '#ef4444';
    let text = '';
    
    if (password.length >= 6) strength += 25;
    if (password.length >= 10) strength += 25;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
    if (/[0-9]/.test(password)) strength += 15;
    if (/[^a-zA-Z0-9]/.test(password)) strength += 10;
    
    if (strength < 25) {
        color = '#ef4444';
        text = 'Weak password';
    } else if (strength < 50) {
        color = '#f59e0b';
        text = 'Fair password';
    } else if (strength < 75) {
        color = '#10b981';
        text = 'Good password';
    } else {
        color = '#059669';
        text = 'Strong password';
    }
    
    strengthBar.style.width = strength + '%';
    strengthBar.style.background = color;
    strengthText.textContent = password.length > 0 ? text : '';
    strengthText.style.color = color;
});

// Password match checker
document.getElementById('confirmPassword').addEventListener('input', function() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = this.value;
    const matchText = document.getElementById('matchText');
    
    if (confirmPassword.length === 0) {
        matchText.textContent = '';
        return;
    }
    
    if (newPassword === confirmPassword) {
        matchText.textContent = '✓ Passwords match';
        matchText.style.color = 'var(--success)';
    } else {
        matchText.textContent = '✗ Passwords do not match';
        matchText.style.color = 'var(--danger)';
    }
});

// Form submission
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const submitBtn = document.getElementById('submitBtn');
    
    // Validation
    if (newPassword.length < 6) {
        showAlert('New password must be at least 6 characters', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'error');
        return;
    }
    
    if (currentPassword === newPassword) {
        showAlert('New password must be different from current password', 'error');
        return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
    
    // Submit
    fetch('/change-password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            // Hide form, show success card
            document.querySelector('.card form').parentElement.style.display = 'none';
            document.getElementById('successCard').style.display = 'block';
            window.scrollTo(0, 0);
        } else {
            showAlert(result.error || 'Error changing password', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check"></i> Change Password';
        }
    })
    .catch(err => {
        showAlert('Error changing password. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Change Password';
    });
});
</script>
{% endblock %}