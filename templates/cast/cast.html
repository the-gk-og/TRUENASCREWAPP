{% extends "base.html" %}

{% block title %}Cast Management - ShowWise{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-users"></i> Cast Management</h1>
    <p class="page-subtitle">Manage cast members and their production assignments</p>
</div>

<div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
    {% if current_user.is_admin %}
    <button onclick="showModal('createCastAccountModal')" class="btn btn-success">
        <i class="fas fa-user-plus"></i> Create Cast Account
    </button>
    <button onclick="showModal('addCastModal')" class="btn btn-primary">
        <i class="fas fa-theater-masks"></i> Assign to Production
    </button>
    {% endif %}
    <select id="eventFilter" onchange="filterByEvent(this.value)" style="padding: 0.625rem 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; min-width: 200px;">
        <option value="">All Productions</option>
        {% for event in events %}
        <option value="{{ event.id }}">{{ event.title }}</option>
        {% endfor %}
    </select>
</div>

<!-- Cast Statistics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Cast</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|length }}</h2>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Lead Roles</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|selectattr('role_type', 'equalto', 'lead')|list|length }}</h2>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Supporting</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|selectattr('role_type', 'equalto', 'supporting')|list|length }}</h2>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Ensemble</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|selectattr('role_type', 'equalto', 'ensemble')|list|length }}</h2>
    </div>
</div>

<!-- Cast List -->
{% if cast_members %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
    {% for cast in cast_members %}
    <div class="card cast-card" data-event-id="{{ cast.event_id or '' }}" style="border-left: 4px solid {% if cast.role_type == 'lead' %}var(--danger){% elif cast.role_type == 'supporting' %}var(--warning){% else %}var(--success){% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="flex: 1; min-width: 0;">
                <h3 style="margin: 0; color: var(--dark); word-break: break-word;">{{ cast.actor_name }}</h3>
                <p style="color: var(--primary); font-size: 1.1rem; margin: 0.5rem 0; font-weight: 600;">
                    as {{ cast.character_name }}
                </p>
            </div>
            <span style="background: {% if cast.role_type == 'lead' %}#fee2e2{% elif cast.role_type == 'supporting' %}#fef3c7{% else %}#dcfce7{% endif %}; 
                         color: {% if cast.role_type == 'lead' %}#991b1b{% elif cast.role_type == 'supporting' %}#78350f{% else %}#065f46{% endif %}; 
                         padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; flex-shrink: 0;">
                {{ cast.role_type }}
            </span>
        </div>
        
        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            {% if cast.user_id %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #10b981;">
                <i class="fas fa-check-circle"></i> Has Cast Portal Access
            </p>
            {% else %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #f59e0b;">
                <i class="fas fa-exclamation-triangle"></i> No Portal Access
            </p>
            {% endif %}
            
            {% if cast.contact_email %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #6b7280; word-break: break-all;">
                <i class="fas fa-envelope"></i> {{ cast.contact_email }}
            </p>
            {% endif %}
            
            {% if cast.contact_phone %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #6b7280;">
                <i class="fas fa-phone"></i> {{ cast.contact_phone }}
            </p>
            {% endif %}
            
            {% if cast.event %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #6b7280;">
                <i class="fas fa-theater-masks"></i> {{ cast.event.title }}
            </p>
            {% endif %}
        </div>
        
        {% if cast.notes %}
        <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; font-style: italic; word-break: break-word;">
            "{{ cast.notes }}"
        </p>
        {% endif %}
        
        {% if current_user.is_admin %}
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="editCast({{ cast.id }})" class="btn btn-primary" style="flex: 1; font-size: 0.85rem; padding: 0.5rem;">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteCast({{ cast.id }})" class="btn btn-danger" style="flex: 1; font-size: 0.85rem; padding: 0.5rem;">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card" style="text-align: center; padding: 3rem;">
    <p style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ­</p>
    <h3 style="color: var(--dark); margin-bottom: 0.5rem;">No cast members yet</h3>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">Create cast accounts and assign them to productions</p>
    {% if current_user.is_admin %}
    <button onclick="showModal('createCastAccountModal')" class="btn btn-success">
        <i class="fas fa-user-plus"></i> Create First Cast Account
    </button>
    {% endif %}
</div>
{% endif %}

<!-- Create Cast Account Modal -->
<div id="createCastAccountModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('createCastAccountModal')">&times;</span>
        <h2><i class="fas fa-user-plus"></i> Create Cast Account</h2>
        <p style="color: #666; margin-bottom: 1.5rem;">Create a new account with cast portal access</p>
        
        <form id="createCastAccountForm">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="newCastUsername" required placeholder="Enter username">
            </div>
            
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="newCastPassword" required placeholder="Enter password (min 6 characters)">
            </div>
            
            <div class="form-group">
                <label>Email (Optional)</label>
                <input type="email" id="newCastEmail" placeholder="email@example.com">
                <small style="color: #666; display: block; margin-top: 0.5rem;">Email will be used to send login credentials</small>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-check"></i> Create Cast Account
            </button>
        </form>
    </div>
</div>

<!-- Assign Cast to Production Modal -->
<div id="addCastModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('addCastModal')">&times;</span>
        <h2 id="castModalTitle"><i class="fas fa-theater-masks"></i> Assign Cast to Production</h2>
        <form id="addCastForm">
            <input type="hidden" id="castId">
            
            <div class="form-group">
                <label>Select Cast Member *</label>
                <select id="castUserId" required>
                    <option value="">-- Select cast member --</option>
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            
            <div class="form-group">
                <label>Character Name *</label>
                <input type="text" id="characterName" required placeholder="Character they play">
            </div>
            
            <div class="form-group">
                <label>Role Type *</label>
                <select id="roleType" required>
                    <option value="lead">Lead Role</option>
                    <option value="supporting">Supporting Role</option>
                    <option value="ensemble">Ensemble</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Contact Phone (Optional)</label>
                <input type="tel" id="contactPhone" placeholder="(123) 456-7890">
            </div>
            
            <div class="form-group">
                <label>Production/Event *</label>
                <select id="castEventId" required>
                    <option value="">-- Select production --</option>
                    {% for event in events %}
                    <option value="{{ event.id }}">{{ event.title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>Director's Notes</label>
                <textarea id="castNotes" rows="3" placeholder="Notes about the role..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-check"></i> Assign to Production
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let castData = {{ cast_json|tojson }};

// Load cast users when modal opens
function loadCastUsers() {
    fetch('/cast/users')
        .then(r => r.json())
        .then(data => {
            const select = document.getElementById('castUserId');
            select.innerHTML = '<option value="">-- Select cast member --</option>';
            data.users.forEach(user => {
                select.innerHTML += `<option value="${user.id}">${user.username}${user.email ? ` (${user.email})` : ''}</option>`;
            });
        });
}

// Create Cast Account
document.getElementById('createCastAccountForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const password = document.getElementById('newCastPassword').value;
    if (password.length < 6) {
        showAlert('Password must be at least 6 characters', 'error');
        return;
    }
    
    const data = {
        username: document.getElementById('newCastUsername').value,
        password: password,
        email: document.getElementById('newCastEmail').value || null
    };
    
    fetch('/cast/create-account', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(`Cast account created: ${result.username}`, 'success');
            document.getElementById('createCastAccountForm').reset();
            hideModal('createCastAccountModal');
            loadCastUsers(); // Refresh the cast users list
        } else {
            showAlert(result.error || 'Error creating account', 'error');
        }
    });
});

// Assign Cast to Production
document.getElementById('addCastForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        user_id: document.getElementById('castUserId').value,
        character_name: document.getElementById('characterName').value,
        role_type: document.getElementById('roleType').value,
        contact_phone: document.getElementById('contactPhone').value || null,
        event_id: document.getElementById('castEventId').value,
        notes: document.getElementById('castNotes').value || ''
    };
    
    fetch('/cast/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Cast member assigned to production!', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showAlert(result.error || 'Error assigning cast', 'error');
        }
    });
});

// Edit cast
function editCast(id) {
    const cast = castData.find(c => c.id === id);
    if (!cast) return;
    
    // For editing, you can reuse the add modal or create a separate edit modal
    // For now, let's just show an alert
    showAlert('Edit functionality: Update the character/role for this cast member', 'info');
}

// Delete cast
function deleteCast(id) {
    if (!confirm('Remove this cast member from the production?')) return;
    
    fetch(`/cast/${id}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showAlert('Cast member removed!', 'success');
                location.reload();
            }
        });
}

// Filter by event
function filterByEvent(eventId) {
    const cards = document.querySelectorAll('.cast-card');
    
    cards.forEach(card => {
        if (!eventId || card.dataset.eventId === eventId) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Show modal and load cast users
function showModal(id) {
    if (id === 'addCastModal') {
        loadCastUsers();
        document.getElementById('addCastForm').reset();
        document.getElementById('castId').value = '';
    }
    document.getElementById(id).style.display = 'block';
}
</script>
{% endblock %}