{% extends "base.html" %}

{% block title %}Cast Management - ShowWise{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-users"></i> Cast Management</h1>
    <p class="page-subtitle">Manage actors, characters, and roles for your productions</p>
</div>

<div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
    {% if current_user.is_admin %}
    <button onclick="showModal('addCastModal')" class="btn btn-success">
        <i class="fas fa-user-plus"></i> Add Cast Member
    </button>
    {% endif %}
    <select id="eventFilter" onchange="filterByEvent(this.value)" style="padding: 0.625rem 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; min-width: 200px;">
        <option value="">All Productions</option>
        {% for event in events %}
        <option value="{{ event.id }}">{{ event.title }}</option>
        {% endfor %}
    </select>
</div>

<!-- Cast Statistics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Cast</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|length }}</h2>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Lead Roles</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|selectattr('role_type', 'equalto', 'lead')|list|length }}</h2>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Supporting</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|selectattr('role_type', 'equalto', 'supporting')|list|length }}</h2>
    </div>
    
    <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">
        <p style="opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem;">Ensemble</p>
        <h2 style="font-size: 2rem; margin: 0; color: white;">{{ cast_members|selectattr('role_type', 'equalto', 'ensemble')|list|length }}</h2>
    </div>
</div>

<!-- Cast List -->
{% if cast_members %}
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
    {% for cast in cast_members %}
    <div class="card cast-card" data-event-id="{{ cast.event_id or '' }}" style="border-left: 4px solid {% if cast.role_type == 'lead' %}var(--danger){% elif cast.role_type == 'supporting' %}var(--warning){% else %}var(--success){% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="flex: 1; min-width: 0;">
                <h3 style="margin: 0; color: var(--dark); word-break: break-word;">{{ cast.actor_name }}</h3>
                <p style="color: var(--primary); font-size: 1.1rem; margin: 0.5rem 0; font-weight: 600;">
                    as {{ cast.character_name }}
                </p>
            </div>
            <span style="background: {% if cast.role_type == 'lead' %}#fee2e2{% elif cast.role_type == 'supporting' %}#fef3c7{% else %}#dcfce7{% endif %}; 
                         color: {% if cast.role_type == 'lead' %}#991b1b{% elif cast.role_type == 'supporting' %}#78350f{% else %}#065f46{% endif %}; 
                         padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; flex-shrink: 0;">
                {{ cast.role_type }}
            </span>
        </div>
        
        <div style="background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            {% if cast.contact_email %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #6b7280; word-break: break-all;">
                <i class="fas fa-envelope"></i> {{ cast.contact_email }}
            </p>
            {% endif %}
            
            {% if cast.contact_phone %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #6b7280;">
                <i class="fas fa-phone"></i> {{ cast.contact_phone }}
            </p>
            {% endif %}
            
            {% if cast.event %}
            <p style="margin: 0.25rem 0; font-size: 0.9rem; color: #6b7280;">
                <i class="fas fa-theater-masks"></i> {{ cast.event.title }}
            </p>
            {% endif %}
            
            {% if not cast.contact_email and not cast.contact_phone and not cast.event %}
            <p style="margin: 0; font-size: 0.85rem; color: #9ca3af; font-style: italic;">No contact information</p>
            {% endif %}
        </div>
        
        {% if cast.notes %}
        <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; font-style: italic; word-break: break-word;">
            "{{ cast.notes }}"
        </p>
        {% endif %}
        
        {% if current_user.is_admin %}
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="editCast({{ cast.id }})" class="btn btn-primary" style="flex: 1; font-size: 0.85rem; padding: 0.5rem;">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteCast({{ cast.id }})" class="btn btn-danger" style="flex: 1; font-size: 0.85rem; padding: 0.5rem;">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card" style="text-align: center; padding: 3rem;">
    <p style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ­</p>
    <h3 style="color: var(--dark); margin-bottom: 0.5rem;">No cast members yet</h3>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">Add actors and characters for your productions</p>
    {% if current_user.is_admin %}
    <button onclick="showModal('addCastModal')" class="btn btn-success">
        <i class="fas fa-user-plus"></i> Add First Cast Member
    </button>
    {% endif %}
</div>
{% endif %}

<!-- Add/Edit Cast Modal -->
<div id="addCastModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('addCastModal')">&times;</span>
        <h2 id="castModalTitle"><i class="fas fa-user-plus"></i> Add Cast Member</h2>
        <form id="addCastForm">
            <input type="hidden" id="castId">
            
            <div class="form-group">
                <label>Actor Name *</label>
                <input type="text" id="actorName" required placeholder="Actor's real name">
            </div>
            
            <div class="form-group">
                <label>Character Name *</label>
                <input type="text" id="characterName" required placeholder="Character they play">
            </div>
            
            <div class="form-group">
                <label>Role Type *</label>
                <select id="roleType" required>
                    <option value="lead">Lead Role</option>
                    <option value="supporting">Supporting Role</option>
                    <option value="ensemble">Ensemble</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="contactEmail" placeholder="actor@example.com">
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="contactPhone" placeholder="(123) 456-7890">
            </div>
            
            <div class="form-group">
                <label>Production/Event</label>
                <select id="castEventId">
                    <option value="">No specific production</option>
                    {% for event in events %}
                    <option value="{{ event.id }}">{{ event.title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea id="castNotes" rows="3" placeholder="Any special notes about this role..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-check"></i> Save Cast Member
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let castData = {{ cast_json|tojson }};

// Add/Update cast
document.getElementById('addCastForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const id = document.getElementById('castId').value;
    const data = {
        actor_name: document.getElementById('actorName').value,
        character_name: document.getElementById('characterName').value,
        role_type: document.getElementById('roleType').value,
        contact_email: document.getElementById('contactEmail').value || null,
        contact_phone: document.getElementById('contactPhone').value || null,
        event_id: document.getElementById('castEventId').value || null,
        notes: document.getElementById('castNotes').value || ''
    };
    
    const url = id ? `/cast/${id}` : '/cast/add';
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert(id ? 'Cast member updated!' : 'Cast member added!', 'success');
            setTimeout(() => location.reload(), 500);
        }
    });
});

// Edit cast
function editCast(id) {
    const cast = castData.find(c => c.id === id);
    if (!cast) return;
    
    document.getElementById('castModalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Cast Member';
    document.getElementById('castId').value = cast.id;
    document.getElementById('actorName').value = cast.actor_name;
    document.getElementById('characterName').value = cast.character_name;
    document.getElementById('roleType').value = cast.role_type;
    document.getElementById('contactEmail').value = cast.contact_email || '';
    document.getElementById('contactPhone').value = cast.contact_phone || '';
    document.getElementById('castEventId').value = cast.event_id || '';
    document.getElementById('castNotes').value = cast.notes || '';
    
    showModal('addCastModal');
}

// Delete cast
function deleteCast(id) {
    if (!confirm('Remove this cast member?')) return;
    
    fetch(`/cast/${id}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showAlert('Cast member removed!', 'success');
                location.reload();
            }
        });
}

// Filter by event
function filterByEvent(eventId) {
    const cards = document.querySelectorAll('.cast-card');
    
    cards.forEach(card => {
        if (!eventId || card.dataset.eventId === eventId) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Reset form when opening modal to add new
function showModal(id) {
    if (id === 'addCastModal' && !document.getElementById('castId').value) {
        document.getElementById('castModalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Add Cast Member';
        document.getElementById('addCastForm').reset();
        document.getElementById('castId').value = '';
    }
    document.getElementById(id).style.display = 'block';
}
</script>
{% endblock %}