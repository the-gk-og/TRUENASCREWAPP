version: '3.8'

services:
  # MongoDB - Required by Rocket.Chat
  mongodb:
    image: mongo:5.0
    container_name: rocketchat-mongo
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
      - mongodb_configdb:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: changeme
    networks:
      - rocketchat

  # Rocket.Chat Server
  rocketchat:
    image: rocketchat/rocket.chat:latest
    container_name: rocketchat
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - mongodb
    environment:
      # Rocket.Chat Configuration
      MONGO_URL: mongodb://admin:changeme@mongodb:27017/rocketchat
      ROOT_URL: http://localhost:3000
      
      # Optional: Configure email
      # MAIL_URL: smtp://user:pass@smtp.example.com:587
      
      # Optional: Configure OAuth / SSO
      # LDAP_ENABLE: 'true'
      # LDAP_HOST: ldap.example.com
      
      # Performance tuning
      INSTANCE_IP: 0.0.0.0
      OMNICHANNEL_ENABLED: 'false'  # Set to true if using omnichannel
    volumes:
      - rocketchat_uploads:/app/uploads
    networks:
      - rocketchat
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: Nginx reverse proxy for production
  # nginx:
  #   image: nginx:alpine
  #   container_name: rocketchat-nginx
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - rocketchat
  #   networks:
  #     - rocketchat

volumes:
  mongodb_data:
  mongodb_configdb:
  rocketchat_uploads:

networks:
  rocketchat:
    driver: bridge

# Usage:
# 1. docker-compose up -d
# 2. Wait for Rocket.Chat to start (check logs: docker-compose logs -f rocketchat)
# 3. Access http://localhost:3000
# 4. Create admin account during setup
# 5. Generate API token and add to ShowWise .env
#
# Stop: docker-compose down
# View logs: docker-compose logs -f rocketchat
# Remove volumes (reset): docker-compose down -v
