{% extends "base.html" %}

{% block title %}My To-Do List - ShowWise{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-tasks"></i> My To-Do List</h1>
    <p class="page-subtitle">Stay organized and track your production tasks</p>
</div>

<div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
    <button onclick="showModal('addTodoModal')" class="btn btn-success">
        <i class="fas fa-plus"></i> Add Task
    </button>
    <button onclick="filterTodos('all')" class="btn btn-primary" id="filterAll" style="opacity: 1;">
        <i class="fas fa-list"></i> All
    </button>
    <button onclick="filterTodos('active')" class="btn btn-primary" id="filterActive" style="opacity: 0.6;">
        <i class="fas fa-hourglass-half"></i> Active
    </button>
    <button onclick="filterTodos('completed')" class="btn btn-primary" id="filterCompleted" style="opacity: 0.6;">
        <i class="fas fa-check-circle"></i> Completed
    </button>
</div>

<!-- Progress Overview -->
{% set completed_count = todos|selectattr('is_completed')|list|length %}
{% set total_count = todos|length %}
<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid var(--primary);">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h3 style="margin: 0; color: var(--primary);">Progress</h3>
            <p style="margin: 0.5rem 0 0 0; color: #1e40af; font-size: 1.1rem;">
                {{ completed_count }} of {{ total_count }} tasks completed
            </p>
        </div>
        <div style="width: 100px; height: 100px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            {% if total_count > 0 %}
            {{ ((completed_count / total_count) * 100)|int }}%
            {% else %}
            0%
            {% endif %}
        </div>
    </div>
</div>

<!-- To-Do Items -->
<div id="todoList">
    {% if todos %}
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for todo in todos %}
        <div class="todo-item" data-status="{{ 'completed' if todo.is_completed else 'active' }}" 
             style="background: {% if todo.is_completed %}#f3f4f6{% else %}white{% endif %}; 
                    border: 2px solid {% if todo.is_completed %}#d1d5db{% else %}var(--border){% endif %}; 
                    border-left: 4px solid {% if todo.priority == 'high' %}var(--danger){% elif todo.priority == 'medium' %}var(--warning){% else %}var(--success){% endif %}; 
                    padding: 1.25rem; 
                    border-radius: 8px; 
                    transition: all 0.2s ease;">
            <div style="display: flex; align-items: start; gap: 1rem;">
                <input type="checkbox" 
                       {% if todo.is_completed %}checked{% endif %} 
                       onchange="toggleTodo({{ todo.id }})"
                       style="width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; margin-top: 0.25rem;">
                
                <div style="flex: 1; min-width: 0;">
                    <h4 style="{% if todo.is_completed %}text-decoration: line-through; color: #9ca3af;{% else %}color: var(--dark);{% endif %} margin: 0 0 0.5rem 0; font-size: 1.1rem; word-break: break-word;">
                        {{ todo.title }}
                    </h4>
                    
                    {% if todo.description %}
                    <p style="color: #6b7280; margin: 0.5rem 0; font-size: 0.9rem; word-break: break-word;">{{ todo.description }}</p>
                    {% endif %}
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.75rem; font-size: 0.85rem;">
                        <span style="background: {% if todo.priority == 'high' %}#fee2e2{% elif todo.priority == 'medium' %}#fef3c7{% else %}#dcfce7{% endif %}; 
                                     color: {% if todo.priority == 'high' %}#991b1b{% elif todo.priority == 'medium' %}#78350f{% else %}#065f46{% endif %}; 
                                     padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                            <i class="fas fa-flag"></i> {{ todo.priority|upper }}
                        </span>
                        
                        {% if todo.due_date %}
                        <span style="background: #eff6ff; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 20px;">
                            <i class="fas fa-calendar"></i> Due: {{ todo.due_date.strftime('%b %d, %Y') }}
                        </span>
                        {% endif %}
                        
                        {% if todo.event %}
                        <span style="background: #fce7f3; color: #9f1239; padding: 0.25rem 0.75rem; border-radius: 20px;">
                            <i class="fas fa-theater-masks"></i> {{ todo.event.title }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <button onclick="deleteTodo({{ todo.id }})" class="btn btn-danger" style="padding: 0.5rem; font-size: 0.85rem; flex-shrink: 0;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <p style="font-size: 3rem; margin-bottom: 1rem;">üìù</p>
        <h3 style="color: var(--dark); margin-bottom: 0.5rem;">No tasks yet!</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">Add your first task to get started</p>
        <button onclick="showModal('addTodoModal')" class="btn btn-success">
            <i class="fas fa-plus"></i> Add First Task
        </button>
    </div>
    {% endif %}
</div>

<!-- Add To-Do Modal -->
<div id="addTodoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('addTodoModal')">&times;</span>
        <h2><i class="fas fa-plus"></i> Add New Task</h2>
        <form id="addTodoForm">
            <div class="form-group">
                <label>Task Title *</label>
                <input type="text" id="todoTitle" required placeholder="What needs to be done?">
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="todoDescription" rows="3" placeholder="Add details about this task..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Priority *</label>
                <select id="todoPriority" required>
                    <option value="low">Low - Can wait</option>
                    <option value="medium" selected>Medium - Important</option>
                    <option value="high">High - Urgent</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Due Date (Optional)</label>
                <input type="date" id="todoDueDate">
            </div>
            
            <div class="form-group">
                <label>Link to Event (Optional)</label>
                <select id="todoEventId">
                    <option value="">No event</option>
                    {% for event in events %}
                    <option value="{{ event.id }}">{{ event.title }} - {{ event.event_date.strftime('%b %d, %Y') }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn btn-success" style="width: 100%;">
                <i class="fas fa-check"></i> Add Task
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Add to-do
document.getElementById('addTodoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        title: document.getElementById('todoTitle').value,
        description: document.getElementById('todoDescription').value,
        priority: document.getElementById('todoPriority').value,
        due_date: document.getElementById('todoDueDate').value || null,
        event_id: document.getElementById('todoEventId').value || null
    };
    
    fetch('/todos/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            showAlert('Task added!', 'success');
            setTimeout(() => location.reload(), 500);
        }
    });
});

// Toggle to-do
function toggleTodo(id) {
    fetch(`/todos/${id}/toggle`, {method: 'POST'})
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                location.reload();
            }
        });
}

// Delete to-do
function deleteTodo(id) {
    if (!confirm('Delete this task?')) return;
    
    fetch(`/todos/${id}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                showAlert('Task deleted!', 'success');
                location.reload();
            }
        });
}

// Filter to-dos
function filterTodos(filter) {
    const items = document.querySelectorAll('.todo-item');
    
    items.forEach(item => {
        if (filter === 'all') {
            item.style.display = 'flex';
        } else {
            item.style.display = item.dataset.status === filter ? 'flex' : 'none';
        }
    });
    
    // Update button styles
    document.querySelectorAll('[id^="filter"]').forEach(btn => {
        btn.style.opacity = '0.6';
    });
    document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).style.opacity = '1';
}
</script>
{% endblock %}