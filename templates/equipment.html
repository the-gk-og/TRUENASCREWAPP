{% extends "base.html" %}

{% block title %}Equipment Management{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>📦 Equipment Management</h2>
        <div>
            <button onclick="showModal('scanModal')" class="btn btn-primary">📱 Scan Barcode</button>
            {% if current_user.is_admin %}
            <button onclick="showModal('addModal')" class="btn btn-success">+ Add Equipment</button>
            {% endif %}
        </div>
    </div>
    
    <div class="form-group">
        <input type="text" id="searchInput" placeholder="🔍 Search by name, barcode, or location..." style="font-size: 1rem;">
    </div>
    
    <div id="equipmentList">
        <table>
            <thead>
                <tr>
                    <th>Barcode</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Notes</th>
                    {% if current_user.is_admin %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in equipment %}
                <tr data-id="{{ item.id }}">
                    <td><code>{{ item.barcode }}</code></td>
                    <td><strong>{{ item.name }}</strong></td>
                    <td>{{ item.category or '-' }}</td>
                    <td>{{ item.location or '-' }}</td>
                    <td>{{ item.notes[:50] }}{% if item.notes|length > 50 %}...{% endif %}</td>
                    {% if current_user.is_admin %}
                    <td>
                        <button onclick="editEquipment({{ item.id }})" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Edit</button>
                        <button onclick="deleteEquipment({{ item.id }})" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Delete</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Scan Modal -->
<div id="scanModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('scanModal')">&times;</span>
        <h2>Scan Barcode</h2>
        
        <div style="margin-bottom: 1rem;">
            <button onclick="startCamera()" class="btn btn-primary" id="startCameraBtn">📷 Start Camera</button>
            <button onclick="stopCamera()" class="btn btn-danger" id="stopCameraBtn" style="display: none;">Stop Camera</button>
        </div>
        
        <div id="cameraContainer" style="display: none; margin-bottom: 1rem;">
            <div id="interactive" class="viewport" style="width: 100%; max-width: 640px; height: 480px; margin: 0 auto; position: relative; border: 2px solid #ddd; border-radius: 6px;"></div>
        </div>
        
        <p style="margin-bottom: 1rem; text-align: center;">OR enter manually:</p>
        <div class="form-group">
            <input type="text" id="barcodeInput" placeholder="Enter barcode..." autofocus>
        </div>
        <button onclick="lookupBarcode()" class="btn btn-primary">Look Up</button>
        <div id="barcodeResult" style="margin-top: 1.5rem;"></div>
    </div>
</div>

<!-- Add/Edit Modal -->
{% if current_user.is_admin %}
<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('addModal')">&times;</span>
        <h2 id="modalTitle">Add Equipment</h2>
        <form id="equipmentForm">
            <input type="hidden" id="equipmentId">
            <div class="form-group">
                <label>Barcode *</label>
                <input type="text" id="barcode" required>
            </div>
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <input type="text" id="category" placeholder="e.g., Lighting, Audio, Video">
            </div>
            <div class="form-group">
                <label>Storage Location</label>
                <input type="text" id="location" placeholder="e.g., Storage Room A, Shelf 3">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="notes" placeholder="Additional information..."></textarea>
            </div>
            <button type="submit" class="btn btn-success">Save Equipment</button>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<!-- QuaggaJS for barcode scanning -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
let allEquipment = {{ equipment_json|tojson }};
let isScanning = false;

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#equipmentList tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
});

// Camera barcode scanning
function startCamera() {
    if (isScanning) return;
    
    document.getElementById('cameraContainer').style.display = 'block';
    document.getElementById('startCameraBtn').style.display = 'none';
    document.getElementById('stopCameraBtn').style.display = 'inline-block';
    
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                width: 640,
                height: 480,
                facingMode: "environment"
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "code_39_vin_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
            ]
        }
    }, function(err) {
        if (err) {
            console.error(err);
            alert('Failed to access camera. Please check permissions.');
            stopCamera();
            return;
        }
        isScanning = true;
        Quagga.start();
    });
    
    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        document.getElementById('barcodeInput').value = code;
        lookupBarcode();
        stopCamera();
    });
}

function stopCamera() {
    if (isScanning) {
        Quagga.stop();
        isScanning = false;
    }
    document.getElementById('cameraContainer').style.display = 'none';
    document.getElementById('startCameraBtn').style.display = 'inline-block';
    document.getElementById('stopCameraBtn').style.display = 'none';
}

// Barcode lookup
document.getElementById('barcodeInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') lookupBarcode();
});

function lookupBarcode() {
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) return;
    
    fetch(`/equipment/barcode/${barcode}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('barcodeResult').innerHTML = 
                    '<div class="alert alert-error">Equipment not found!</div>';
            } else {
                document.getElementById('barcodeResult').innerHTML = `
                    <div class="card" style="background: #f8f9fa; padding: 1.5rem;">
                        <h3>${data.name}</h3>
                        <p><strong>Barcode:</strong> ${data.barcode}</p>
                        <p><strong>Category:</strong> ${data.category || 'N/A'}</p>
                        <p><strong>Location:</strong> <span style="background: #ffd700; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;">${data.location || 'N/A'}</span></p>
                        ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : ''}
                    </div>
                `;
            }
        });
}

{% if current_user.is_admin %}
// Add/Edit equipment
document.getElementById('equipmentForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('equipmentId').value;
    const data = {
        barcode: document.getElementById('barcode').value,
        name: document.getElementById('name').value,
        category: document.getElementById('category').value,
        location: document.getElementById('location').value,
        notes: document.getElementById('notes').value
    };
    
    const url = id ? `/equipment/update/${id}` : '/equipment/add';
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            location.reload();
        }
    });
});

function editEquipment(id) {
    const item = allEquipment.find(e => e.id === id);
    if (!item) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Equipment';
    document.getElementById('equipmentId').value = item.id;
    document.getElementById('barcode').value = item.barcode;
    document.getElementById('name').value = item.name;
    document.getElementById('category').value = item.category || '';
    document.getElementById('location').value = item.location || '';
    document.getElementById('notes').value = item.notes || '';
    
    showModal('addModal');
}

function deleteEquipment(id) {
    if (!confirm('Delete this equipment item?')) return;
    
    fetch(`/equipment/delete/${id}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(result => {
            if (result.success) location.reload();
        });
}
{% endif %}
</script>
{% endblock %}